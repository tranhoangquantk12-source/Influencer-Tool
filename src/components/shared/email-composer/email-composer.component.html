<!-- Composer Modal -->
<div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in" (click)="close.emit()">
  <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-[90vh] max-h-[800px] flex flex-col" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="flex items-center justify-between px-4 py-2 bg-slate-100 rounded-t-lg border-b border-slate-200">
      <h3 class="text-base font-semibold text-slate-800">New Message</h3>
      <button (click)="close.emit()" class="p-1.5 text-slate-500 hover:bg-slate-200 transition-colors rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
      </button>
    </div>

    <div class="flex flex-col flex-grow min-h-0">
      <!-- Recipient Fields -->
      <div class="p-4 text-sm border-b border-slate-200 space-y-2">
        <div class="flex items-start">
          <label class="text-slate-500 pt-1.5 w-12 text-right pr-2">To</label>
          <div class="flex flex-wrap items-center gap-1 flex-1 min-h-[30px]">
            @for(pill of toRecipients(); track pill.email; let i = $index) {
              <div class="flex items-center gap-1 bg-slate-100 pl-2 text-xs font-medium rounded-full">
                <span>{{ pill.name }}</span>
                <button (click)="removeRecipient('to', i)" class="p-1 hover:bg-slate-200 rounded-full text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                </button>
              </div>
            }
            <input [(ngModel)]="toInput" (keydown.enter)="addRecipient('to')" (keydown.tab)="addRecipient('to')" type="text" class="flex-grow focus:outline-none min-w-[150px] p-1">
          </div>
          <button (click)="showCcBcc.set(!showCcBcc())" class="text-slate-500 hover:text-slate-800 text-xs font-medium self-center">Cc/Bcc</button>
        </div>

        @if(showCcBcc()) {
          <div class="flex items-start border-t border-slate-100 pt-2">
            <label class="text-slate-500 pt-1.5 w-12 text-right pr-2">Cc</label>
            <div class="flex flex-wrap items-center gap-1 flex-1 min-h-[30px]">
              @for(pill of ccRecipients(); track pill.email; let i = $index) {
                <div class="flex items-center gap-1 bg-slate-100 pl-2 text-xs font-medium rounded-full">
                  <span>{{ pill.name }}</span>
                  <button (click)="removeRecipient('cc', i)" class="p-1 hover:bg-slate-200 rounded-full text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                  </button>
                </div>
              }
              <input [(ngModel)]="ccInput" (keydown.enter)="addRecipient('cc')" (keydown.tab)="addRecipient('cc')" type="text" class="flex-grow focus:outline-none min-w-[150px] p-1">
            </div>
          </div>
          <div class="flex items-start border-t border-slate-100 pt-2">
            <label class="text-slate-500 pt-1.5 w-12 text-right pr-2">Bcc</label>
            <div class="flex flex-wrap items-center gap-1 flex-1 min-h-[30px]">
              @for(pill of bccRecipients(); track pill.email; let i = $index) {
                <div class="flex items-center gap-1 bg-slate-100 pl-2 text-xs font-medium rounded-full">
                  <span>{{ pill.name }}</span>
                  <button (click)="removeRecipient('bcc', i)" class="p-1 hover:bg-slate-200 rounded-full text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                  </button>
                </div>
              }
              <input [(ngModel)]="bccInput" (keydown.enter)="addRecipient('bcc')" (keydown.tab)="addRecipient('bcc')" type="text" class="flex-grow focus:outline-none min-w-[150px] p-1">
            </div>
          </div>
        }
      </div>
      <input [(ngModel)]="subject" type="text" placeholder="Subject" class="px-4 py-2 border-b border-slate-200 focus:outline-none text-sm w-full">

      <!-- Textarea for body -->
      <div class="flex-grow overflow-y-auto p-4">
        <textarea [(ngModel)]="bodyContent" 
                  placeholder="Write your message here..."
                  class="w-full h-full p-2 border border-slate-200 rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-[#003fb5]/20"></textarea>
      </div>
    </div>

    <!-- Footer -->
    <div class="p-3 bg-slate-50 border-t border-slate-200 flex justify-between items-center rounded-b-lg">
      <button (click)="handleSend()" class="primary-btn px-6 py-2 bg-[#003fb5] text-white text-sm font-semibold shadow-sm hover:bg-blue-700 flex items-center gap-2">
        Send
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
      </button>
      <button (click)="close.emit()" class="p-2 text-slate-500 hover:text-slate-700">
         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
      </button>
    </div>
  </div>
</div>